# سیاست یکپارچهٔ «ماتریس احراز صلاحیت» و تخصیص پشتیبان
**نسخهٔ سند:** v1.0.3 (Proposed) · **هماهنگ با:** SSoT v1.0.2 + README v1.0.4 Patch  
**مخاطب:** مدیر محصول، مهندس داده، توسعه‌دهنده، اپراتور تخصیص

> هدف این سند: تبدیل تمام قواعد پراکنده به یک **Policy** یکپارچه و «شیرفهم»—هم توضیحی، هم فنی—تا هر شخصی، حتی بدون آشنایی قبلی، بتواند سازوکار ساخت «Eligibility Matrix» و نحوهٔ استفادهٔ آن در برنامهٔ تخصیص پشتیبان را کاملاً درک و اجرا کند.

---

## 0) واژگان و اختصارات (Glossary)
- **پشتیبان (Mentor):** نیروی انسانی ارائه‌دهندهٔ خدمات به دانش‌آموز.
- **دانش‌آموز (Student):** رکورد ورودی از فایل دانش‌آموزان (Report.xlsx / StudentReport).
- **ماتریس احراز صلاحیت (Eligibility Matrix):** جدولی که برای هر پشتیبان، مجموعه‌ای از ترکیب‌های قابل‌پذیرش را تولید می‌کند (گروه/جنسیت/وضعیت/مرکز/مالی/مدرسه).
- **عادی/مدرسه‌ای:** نوع سطر در ماتریس. عادی: توسط «کدپستی» پشتیبان؛ مدرسه‌ای: توسط «کد مدرسه».
- **گیت ظرفیت R0 (Capacity Gate):** حذف پشتیبان‌هایی که از سقف ظرفیت ویژه عبور کرده‌اند.
- **Crosswalk:** نگاشت نام گروه آزمایشی ↔ کد گروه، با پشتیبانی از **Synonyms** و **Buckets**.
- **Alias (جایگزین):** مقدار کلید انتساب برای نوع «عادی» (معمولاً کدپستی ۴ رقمی). در نوع مدرسه‌ای، Alias = «کد کارمندی پشتیبان».
- **مرکز:** یکی از {مرکز=0، گلستان=1، صدرا=2}. از نام مدیر استنتاج می‌شود.
- **مالی:** یکی از {0=عادی، 1=بنیاد، 3=حکمت}.

---

## 1) دامنه و هدف
1. تولید **Eligibility Matrix** یکپارچه از ورودی‌های چندگانه (Inspactor/School/Crosswalk).
2. استفاده از ماتریس برای **تخصیص خودکار پشتیبان** به دانش‌آموزان با **انتخاب بهینه** (بر اساس ظرفیت خالی/نسبت اشغال).
3. ارائهٔ **خروجی استاندارد** برای سامانه‌های بالادست/پایین‌دست (ImportToSabt، داشبوردها و …).

### 1.2) MentorSchoolBindingPolicy (Policy/SSoT, stable IDs)
- **Empty/Zero tokens → Global mentor:** اگر توکن مدرسه در Policy خالی/0 باشد، منتور «آزاد» است (`has_school_constraint=False`) و در diagnostics `unmatched_schools` یا `invalid_mentors` ظاهر نمی‌شود.
- **Non-empty, mapped tokens → Restricted mentor:** توکن مدرسه‌ای که به کد معتبر نگاشت می‌شود، منتور را به همان مدرسه مقید می‌کند (`has_school_constraint=True`, `کد مدرسه>0`).
- **Non-empty, unmapped tokens → Drop + Diagnostics:** توکن نامعتبر/نگاشت‌نشده باعث حذف منتور مقید از ماتریس/تخصیص می‌شود و در `unmatched_schools`/`invalid_mentors` برای اپراتور و QA گزارش می‌گردد.
- **QA ارتباطی:** `QA_RULE_SCHOOL_01` این سیاست را می‌سنجد و هر نشت منتور آزاد به diagnostics یا نبود `کد مدرسه` برای منتور مقید را خطا می‌داند. `QA_RULE_ALLOC_01` به اجرای دقیق سیاست ظرفیت/ظرفیت باقی‌مانده وابسته است.
- **Stability:** شناسه‌های QA_RULE_* در Policy/SSoT/Docs/کد مشترک هستند (مثلاً QA_RULE_STU_01، QA_RULE_SCHOOL_01) و برای QA گزارش‌ها باید ثابت بمانند.

### 1.1) لایهٔ QA و قوانین ثابت (QA_RULE)
- **QA_RULE_STU_01 — شمارش جهانی دانش‌آموز:** تعداد دانش‌آموز فعال در StudentReport، ماتریس و فایل تخصیص باید یکسان باشد؛ هر اختلافی خطای قطعی است.
- **QA_RULE_STU_02 — شمارش منتور به منتور:** برای هر منتور، تعداد دانش‌آموز تخصیص‌یافته باید با شمار انتظار (Inspactor یا ظرفیت اعلامی) برابر باشد.
- **QA_RULE_JOIN_01 — صحت ۶ کلید join:** هر شش کلید فاز Trace باید در ماتریس موجود، نوع int و بدون مقدار تهی باشند (Policy v1.0.3).
- **QA_RULE_SCHOOL_01 — تفکیک منتور آزاد/مدرسه‌ای:** منتورهای بدون محدودیت مدرسه نباید در لیست خطا یا متریک ناسازگاری مدرسه دیده شوند؛ منتورهای مقید باید کد مدرسه معتبر داشته باشند و در صورت عدم تطبیق در Diagnostics ظاهر شوند.
- **QA_RULE_ALLOC_01 — ظرفیت و نسبت اشغال:** در خلاصهٔ تخصیص، `assigned_count ≤ remaining + allocations_new` و `occupancy_ratio = allocations_new / (allocations_new + remaining)` باید برقرار باشد.
- **QA_RULE_OUT_01 — شِما/حضور خروجی‌ها:** شیت‌های اصلی (`matrix`, `validation`, `invalid_mentors`, `allocations`, `trace` و …) باید مطابق قرارداد تولید شوند و در صورت فقدان، گزارش QA باید خطا را منعکس کند.

> این قوانین در لایهٔ Core QA پیاده‌سازی و پس از ساخت ماتریس/تخصیص به‌صورت خودکار اجرا می‌شوند تا سیاست «عدم ابهام» را عملی کنند.

---

## 2) قرارداد ورودی‌ها (Data Contracts)

### 2.1) InspactorReport.xlsx (شیت اول)
**حداقل لازم برای تولید ردیف‌ها:**
- `نام پشتیبان` (string)
- `نام مدیر` (string)
- `کد کارمندی پشتیبان` (string/int غیرخالی)

**ستون‌های توصیه‌شده/تاثیرگذار:**
- `کدپستی` (برای تعیین «عادی» و مقدار Alias)
- `نام مدرسه 1..4` و/یا `تعداد مدارس تحت پوشش` (برای تعیین «مدرسه‌ای»)
- `گروه آزمایشی*` (یک یا چند ستون یا `شامل گروه های آزمایشی` برای حالت کدهای بازه/لیست)
- `جنسیت` (در صورت وجود)
- **برای R0:** `تعداد داوطلبان تحت پوشش`، `تعداد تحت پوشش خاص`

### 2.2) SchoolReport.xlsx (شیت اول)
- `کد مدرسه` (اجباری)
- حداقل یک ستون نام مدرسه (مثل `نام مدرسه` یا `نام مدرسه 1`)

### 2.3) Crosswalk.xlsx
- شیت `پایه تحصیلی (گروه آزمایشی)` با ستون‌های `گروه آزمایشی`, `کد گروه`, `مقطع تحصیلی`
- شیت اختیاری `Synonyms` (دو ستون: from/alias و to/target)

### 2.4) StudentReport.xlsx (اختیاری – برای اعتبارسنجی/تخصیص)
- یکی از `کد پستی`/`کد جایگزین`
- `نام پشتیبان`، `مدیر`، `گروه آزمایشی`، نام مدرسه
- `جنسیت` (در صورت نبود، از Policy استنباط می‌شود)

---

## 3) نرمال‌سازی داده (Normalization)
برای تمامی ورودی‌ها یکسان اعمال شود:
- NFKD + حذف ترکیب‌ها (اعراب)
- یکسان‌سازی حروف عربی→فارسی (`ي→ی`, `ك→ک`)
- تبدیل ارقام فارسی→لاتین
- حذف کاراکترهای bidi (`\u200c…`) و non-word
- فشرده‌سازی فاصله‌ها، lower-case
- تبدیل عددنماها به نمایش پایدار (`"10.0"` → `"10"`)

---

## 4) تشخیص نوع پشتیبان و سیاست وضعیت
### 4.1) تشخیص نوع
- **Normal (عادی):** اگر `کدپستی` معتبر (۴ رقمی در بازهٔ 1000..9999) موجود باشد.
- **School (مدرسه‌ای):** اگر `تعداد مدارس تحت پوشش > 0` یا هر یک از `نام مدرسه 1..4` به «کد مدرسه» معتبر نگاشت شود.
- **Dual:** اگر هر دو شرط برقرار باشد (ردیف عادی + ردیف‌های مدرسه‌ای تولید می‌شوند).

### 4.2) سیاست وضعیت (Student/Graduate)
- **Normal:** برای هر ترکیب، **دو سطر** بساز: `دانش‌آموز=1` و `فارغ‌التحصیل=0`.
- **School:** فقط `دانش‌آموز=1`.

---

## 5) نگاشت گروه‌های آزمایشی (Crosswalk, Synonyms, Buckets)
- منبع اصلی Crosswalk (`گروه آزمایشی` ↔ `کد گروه`).
- پشتیبانی از **Synonyms** (هم‌ارزها) و **Buckets** (مثلاً «کل متوسطه ۱/۲»، «کنکوری»).
- پشتیبانی از **Range/List** در `شامل گروه های آزمایشی` (مثل `31:35,41`).  
- موارد ناشناخته → ثبت در `unseen_groups` (برای بازبینی، نه نگاشت اجباری).

---

## 6) مدرسه و Alias
- **School Rows:**  
  - `عادی مدرسه = "مدرسه‌ای"`  
  - `کد مدرسه` از SchoolReport (در صورت نامعتبر/خالی در خروجی ⇒ **0**)  
  - `جایگزین = کد کارمندی پشتیبان`
- **Normal Rows:**  
  - `عادی مدرسه = "عادی"`  
  - `کد مدرسه = 0` (طبق پچ v1.0.4)  
  - `جایگزین = کدپستی` (اگر معتبر). اگر معتبر نبود ⇒ `جایگزین = کد کارمندی پشتیبان` (Fallback)

---

## 7) مالی و مرکز
- **مالی حکمت بنیاد:** مقدار یکی از `{0, 1, 3}` در تمام ترکیب‌ها ضرب می‌شود.  
  - 0: عادی، 1: بنیاد، 3: حکمت
- **مرکز:** از نام مدیر بر اساس نگاشت پیکربندی (`center_manager_map`) استخراج می‌شود:  
  - مرکز=0، گلستان=1، صدرا=2

---

## 8) Capacity Gate (R0)
اگر ستون‌ها حاضرند: رکوردهایی **نگه‌داری** شوند که
```
تعداد داوطلبان تحت پوشش < تعداد تحت پوشش خاص
```
سایر رکوردها → `removed_mentors` با ذکر دلیل. اگر ستون‌ها موجود نیستند: **Skip** و در `validation` با `r0_skipped=1` ثبت شود.

---

## 9) اسکیمای خروجی استاندارد (Eligibility Matrix)
شیت `matrix` شامل فیلدهای زیر (نام‌ها دقیقاً همین باشند):
- **کلیدی/ساختاری:**  
  `counter`, `جایگزین`, `پشتیبان`, `مدیر`, `ردیف پشتیبان`, `نام رشته`, `کدرشته`  
- **قواعد تخصیص:**  
  `جنسیت`, `دانش آموز فارغ`, `مرکز گلستان صدرا`, `مالی حکمت بنیاد`, `کد مدرسه`, `عادی مدرسه`, `نام مدرسه`
- **خوانایی/کمکی:**  
  `جنسیت2`, `دانش آموز فارغ2`, `مرکز گلستان صدرا3`

**مرتب‌سازی پایدار (Stable Sort):**
```
مرکز گلستان صدرا ↑ , کدرشته ↑ , کد مدرسه (خالی=0) ↑ , جایگزین ↑
```
سپس `counter` از 1..N درج گردد.

**Sheets کمکی:**  
`validation`, `removed_mentors`, `unmatched_schools`, `unseen_groups`, `invalid_mentors`, `meta`

---

## 10) استفاده در تخصیص دانش‌آموز → پشتیبان
**کلیدهای تطبیق (Join Keys) برای هر دانش‌آموز:**
```
کدرشته + جنسیت + دانش آموز فارغ + مرکز گلستان صدرا + مالی حکمت بنیاد + کد مدرسه
```
- اگر `کد مدرسه = 0` ⇒ جستجو در ردیف‌های **عادی** ماتریس؛
- اگر `کد مدرسه > 0` ⇒ جستجو در ردیف‌های **مدرسه‌ای** ماتریس (و هم‌خوانی کد مدرسه).

**انتخاب پشتیبان نهایی (Ranking):**
1. **کمترین نسبت اشغال**:  
   `ratio = (covered_now + allocations_new) / capacity_limit`  (کمتر بهتر)  
   - اگر دادهٔ ظرفیت در ماتریس نیست، از منبع ظرفیتی خارجی بخوان و Join کن.
2. تساوی ۱: **کمترین allocations_new**
3. تساوی ۲: **smallest mentor_id**

**خروجی برای ImportToSabt (نمونهٔ ستون‌ها):**
- `کد پستی` = مقدار **«جایگزین»** از ردیف منتخب ماتریس  
  - عادی ⇒ کدپستی پشتیبان  
  - مدرسه‌ای ⇒ کد کارمندی پشتیبان (طبق Rule)
- `پشتیبان` = نام پشتیبان منتخب  
- سایر ستون‌ها مطابق قالب ImportToSabt (حفظ می‌شوند یا از Report درج می‌گردند)

---

## 11) مثال گام‌به‌گام (Walkthrough)
**دانش‌آموز ورودی:**
```
کدرشته=3 , جنسیت=1 , دانش آموز فارغ=0 , مرکز=0 , مالی=3 , کد مدرسه=0
```
1) نوع = «عادی» (چون کد مدرسه=0).  
2) در ماتریس، ردیف‌های عادی با همین 6 کلید فیلتر می‌شود.  
3) 5 پشتیبان کاندید یافت می‌شود.  
4) بر اساس ظرفیت، پشتیبان «سه» بهترین است.  
5) در ImportToSabt:  
   - `کد پستی` = `جایگزین` آن ردیف (کدپستی پشتیبان سه)  
   - `پشتیبان` = نام پشتیبان سه

---

## 12) لاگ و Explainability
برای هر تصمیم «انتخاب پشتیبان»، این تریس کوتاه نوشته شود:
- `student_id`, `join_keys`, تعداد کاندیدها، علت حذف هر کاندید (مثلاً مرکز ناسازگار، ظرفیت، مدرسه، گروه، جنسیت، وضعیت، مالی)، امتیاز نهایی منتخب، tie-breakers.

---

## 13) کنترل کیفیت (QA) و پذیرش (Acceptance)
- اجرای دقیق **سیاست وضعیت عادی/مدرسه‌ای**.
- اعمال R0 و ثبت `r0_skipped` در صورت نبود ستون‌ها.
- خروجی `matrix` با نام ستون‌های استاندارد و **Sort پایدار** + `counter`.
- تولید Sheets کمکی در صورت وجود خطا/عدم‌تطبیق.
- در پچ v1.0.4: **کد مدرسه خالی ⇒ 0** در خروجی رعایت شده باشد.
- در تخصیص دانش‌آموز: کلید شش‌گانه + انتخاب بر اساس نسبت اشغال + تریس توضیح.

**Checklists کوتاه:**  
- [ ] ستون‌های ورودی موجود و نرمال‌سازی شده‌اند  
- [ ] Crosswalk/Synonyms/Buckets درست بارگذاری شده‌اند  
- [ ] School mappings ساخته شده‌اند  
- [ ] R0 اجرا/ثبت شده است  
- [ ] Matrix ساخته و Sort/Counter اعمال شده است  
- [ ] Sheets کمکی/متا ساخته شده است  
- [ ] مثال‌های نمونه «Match/No-Match» تست شده‌اند  
- [ ] تخصیص دانش‌آموز → ImportToSabt صحیح

---

## 14) پیکربندی‌ها (Config Surface)
- `center_manager_map`: نگاشت نام مدیر → {0/1/2}
- `finance_variants`: tuple پیش‌فرض `(0,1,3)`
- `can_allocate_truthy`: لیست مقادیر «بله»
- بازه‌های اعتبار `کدپستی`، سیاست جنسیت پیش‌فرض در StudentReport، حد آستانه فازی نام مدرسه

---

## 15) JSON Spec پیشنهادی (برای مصرف مشترک Python/WordPress)
```json
{
  "version": "1.0.3",
  "normal_statuses": [1, 0],
  "school_statuses": [1],
  "postal_valid_range": [1000, 9999],
  "finance_variants": [0, 1, 3],
  "center_map": {
    "شهدخت کشاورز": 1,
    "آیناز هوشمند": 2,
    "*": 0
  },
  "school_code_empty_as_zero": true,
  "alias_rule": {
    "normal": "postal_or_fallback_mentor_id",
    "school": "mentor_id"
  },
  "capacity_gate": {
    "enabled": true,
    "rule": "covered_now < special_limit"
  },
  "join_keys": ["کدرشته","جنسیت","دانش آموز فارغ","مرکز گلستان صدرا","مالی حکمت بنیاد","کد مدرسه"],
  "ranking": ["min_occupancy_ratio","min_allocations_new","min_mentor_id"],
  "logging": {"decision_trace": true}
}
```

---

## 16) پیاده‌سازی مرجع (Pseudo/Python)
```python
# 1) build eligibility_matrix (as per sections 3..9)
# 2) allocate

def select_mentor_for_student(student, matrix, capacity_df):
    # build join keys from student record
    key = {
        "کدرشته": student["کدرشته"],
        "جنسیت": student["جنسیت"],
        "دانش آموز فارغ": student["دانش آموز فارغ"],
        "مرکز گلستان صدرا": student["مرکز گلستان صدرا"],
        "مالی حکمت بنیاد": student["مالی حکمت بنیاد"],
        "کد مدرسه": student.get("کد مدرسه", 0) or 0
    }

    # filter matrix
    pool = matrix.query(
        "کدرشته==@key['کدرشته'] and جنسیت==@key['جنسیت'] and "
        "دانش_آموز_فارغ==@key['دانش آموز فارغ'] and مرکز_گلستان_صدرا==@key['مرکز گلستان صدرا'] and "
        "مالی_حکمت_بنیاد==@key['مالی حکمت بنیاد'] and کد_مدرسه==@key['کد مدرسه']"
        .replace(" ", "_")
    ).copy()

    if pool.empty:
        return None, {"reason": "no_candidate", "key": key}

    # join capacity metrics: covered_now, special_limit, allocations_new
    pool = pool.merge(capacity_df, how="left", on=["پشتیبان"])
    pool["capacity_limit"] = pool["special_limit"].fillna(0)
    pool["covered_now"] = pool["covered_now"].fillna(0)
    pool["allocations_new"] = pool["allocations_new"].fillna(0)

    # occupancy ratio
    denom = pool["capacity_limit"].replace(0, 1)  # avoid zero-div
    pool["occupancy_ratio"] = (pool["covered_now"] + pool["allocations_new"]) / denom

    # ranking
    pool.sort_values(
        by=["occupancy_ratio","allocations_new","ردیف پشتیبان"],
        ascending=[True, True, True],
        inplace=True
    )

    best = pool.iloc[0].to_dict()
    trace = {
        "key": key,
        "candidates": len(pool),
        "top5": pool[["پشتیبان","occupancy_ratio","allocations_new"]].head(5).to_dict(orient="records")
    }
    return best, trace
```

---

## 17) نسخه‌بندی و تغییرات
- **v1.0.3 (Proposed):** یکپارچه‌سازی Policy، تثبیت «SchoolCode=0 when empty»، تعریف کلیدهای شش‌گانه، Ranking استاندارد، لاگ تصمیم.
- **v1.0.2 (SSoT):** قاعدهٔ Normal/School + R0 + Crosswalk/Synonyms + مالی سه‌حالته + نگاشت مرکز.
- **v1.0.1 و قبل:** قواعد پایهٔ نسل اول.

---

### پایان
این سند، «حقیقتِ واحد» اجرایی پیشنهادی است. هر پیاده‌سازی (Python/WordPress/…)، با تبعیت از همین Policy، خروجی هم‌ارز می‌سازد و به‌سادگی قابل اعتبارسنجی، Audit و مانیتورینگ خواهد بود.