# سند حقیقت (SSoT) نسخهٔ **1.0.2** — موتور ساخت «ماتریس احراز صلاحیت» (Eligibility Matrix)

**مالک:** تیم RH
 **دامنه:** تولید ماتریس احراز صلاحیت پشتیبان‌ها + اعتبارسنجی اختیاری با StudentReport
 **مخاطب:** توسعه‌دهندگان، تحلیل‌گران داده، QA، عملیات
 **اصل راهنما:** هر تغییر **ابتدا** در این سند نسخه‌گذاری شود؛ کد باید عیناً تابع این سند باشد.

------

## 1) هدف و خروجی‌ها

### 1.1 هدف

ایجاد یک ماتریس پایدار، قابل‌ممیزی و یکنواخت از «گزینه‌های مجاز تخصیص» برای هر پشتیبان، با پوشش حالت‌های **عادی/مدرسه‌ای/دوگانه**، گیت ظرفیت (R0)، نگاشت مرکز، نگاشت گروه‌های آزمایشی، و کراس‌پروداکت مالی.

### 1.2 خروجی‌های استاندارد

- `eligibility_matrix.xlsx` با شیت‌های:
  - `matrix` (ماتریس اصلی)
  - `validation` (آمار و پرچم‌ها)
  - `removed_mentors` (حذف‌شده‌های R0)
  - `unmatched_schools` (مدارس ناشناخته)
  - `unseen_groups` (توکن‌های گروه ناشناخته)
  - `invalid_mentors` (ردیف‌های فاقد «کد کارمندی پشتیبان»)
  - `meta` (متادیتا/ممیزی)
- `eligibility_matrix.csv` معادل شیت `matrix`
- اگر ولیدیشن با StudentReport فعال باشد:
  - `matrix_vs_students_validation.xlsx` (شیت‌های `checks`, `breakdown`, `summary`, `meta`)
  - در صورت عدم‌انطباق: `unmatched_students.csv`

------

## 2) واژگان (Glossary)

- **پشتیبان عادی (Normal mentor):** پشتیبانی که «کدپستی 4رقمی 1000..9999» دارد.
   **سیاست وضعیت:** می‌تواند **دانش‌آموز** و **فارغ‌التحصیل** بگیرد ⇒ برای هر ترکیب، **دو سطر** (status=1 و status=0) ساخته می‌شود.
- **پشتیبان مدرسه‌ای (School mentor):** پشتیبانی که برای مدارس مشخص تعریف شده است (از طریق «تعداد مدارس تحت پوشش>0» یا وجود کُد مدرسه در «نام مدرسه 1..4»).
   **سیاست وضعیت:** فقط **دانش‌آموز** می‌گیرد ⇒ همیشه `دانش آموز فارغ=1`.
- **پشتیبان دوگانه (Dual):** هر دو قابلیت را دارد (هم عادی، هم مدرسه‌ای) — ترکیب قواعد بالا.
- **Alias / «جایگزین»:** کلید تطبیق:
  - سطر **عادی**: `جایگزین = کدپستی 4رقمی پشتیبان`
  - سطر **مدرسه‌ای**: `جایگزین = کد کارمندی پشتیبان`
- **R0 (Capacity Gate):** نگه‌داشتن پشتیبان فقط اگر `تحت پوشش فعلی < ظرفیت خاص`.
- **مرکز:** از نام مدیر نگاشت می‌شود: «مرکز=0»، «گلستان=1»، «صدرا=2».
- **گروه آزمایشی:** از Crosswalk (نام ↔ کد) + باکت‌ها + هم‌معنی‌ها.
- **Finance (مالی حکمت بنیاد):** برای هر سطر سه حالت: `0 (Normal)`, `1 (Bonyad)`, `3 (Hekmat)`.

------

## 3) قرارداد ورودی‌ها (Data Contracts)

### 3.1 InspactorReport.xlsx (شیت اول)

**الزامی:**

- «نام پشتیبان»، «نام مدیر»، **«کد کارمندی پشتیبان»** (شناسهٔ یکتا)
- ≥1 ستون «گروه آزمایشی …»

**تشخیص نوع پشتیبان:**

- «کدپستی» چهاررقمی 1000..9999 → قابلیت «عادی»
- «تعداد مدارس تحت پوشش» > 0 یا وجود «کُد مدرسه» غیرصفر در «نام مدرسه 1..4» → قابلیت «مدرسه‌ای»

**ظرفیت (R0):**

- «تعداد داوطلبان تحت پوشش»، «تعداد تحت پوشش خاص» (در صورت نبود، R0=Skip)

**اختیاری:** «جنسیت»، «وضعیت تحصیلی»، «نوع دانش آموز»، «امکان جذب دانش آموز»، «ردیف پشتیبان»

> ⛔️ ستون «کد کارمندی» (غیر از «کد کارمندی پشتیبان») معتبر نیست و نباید استفاده شود.

### 3.2 SchoolReport.xlsx

- «کد مدرسه» (کلید)
- ≥1 ستون «نام مدرسه …» (برای نمایش اسم از روی کُد)

### 3.3 Crosswalk.xlsx

- شیت **«پایه تحصیلی (گروه آزمایشی)»**: «گروه آزمایشی»، «کد گروه»، «مقطع تحصیلی»
- شیت اختیاری **«Synonyms»**: `from/alias` → `to/target` (هم‌معنی‌ها)

### 3.4 StudentReport.xlsx (اختیاری ولیدیشن)

- «کد پستی» **یا** «کد جایگزین» (کد پستی دانش‌آموز)
- «نام پشتیبان»، «مدیر»، «گروه آزمایشی»، «نام مدرسه 1» (برای نگاشت اسم→کُد مدرسه)، و اختیاری «جنسیت»

------

## 4) نرمال‌سازی فارسی

- یکسان‌سازی «ی/ك»، حذف اعراب (NFKD)، حذف کنترل‌های bidi، تبدیل ارقام فارسی→لاتین، فشرده‌سازی فاصله‌ها، lowercase.
- تبدیل رشته‌های عددنما به نمایش پایدار (مثلاً حذف `.0`).

------

## 5) گیت ظرفیت (R0)

- اگر دو ستون ظرفیت وجود داشته باشد: **نگه‌داشتن** فقط وقتی `Covered < Special`. مساوی/بزرگ‌تر → حذف به `removed_mentors` با دلیل.
- اگر نبود: R0 **Skip** و در `validation` مقدار `r0_skipped=1`.

------

## 6) سیاست تشخیص نوع پشتیبان

- **can_school=True** اگر `تعداد مدارس>0` یا هرکدام از «نام مدرسه 1..4» دارای **کُد مدرسهٔ غیرصفر** باشد.
- **can_normal=True** اگر «کدپستی» 4رقمی 1000..9999 باشد.
- نتایج ممکن: فقط مدرسه‌ای / فقط عادی / دوگانه.

> اگر به‌اشتباه نام مدرسه به‌جای کُد در «نام مدرسه …» آمده باشد، تلاش برای نگاشت اسم→کُد انجام می‌شود؛ در غیر این صورت مورد در `unmatched_schools` ثبت می‌شود.

------

## 7) نگاشت «گروه آزمایشی»

- منبع اصلی: شیت Crosswalk (نام↔کُد).
- گسترش‌ها:
  - **Synonyms:** از شیت `Synonyms` + هم‌معنی‌های داخلی (مثلاً «کل متوسطه 1» → باکت «متوسطه اول»).
  - **Buckets:** «کل متوسطه اول/دوم»، «کل دبستان»، «کل هنرستان»، «کنکوری‌ها».
  - **پایه×رشته:** «دهم/یازدهم/دوازدهم × ریاضی/تجربی/انسانی/علوم و معارف اسلامی».
- **ستون اختیاری «شامل گروه‌های آزمایشی» (Included):**
   پشتیبانی از قالب‌های زیر:
  - تفکیک با «,» یا «،»
  - بازه با `:` یا `-` یا `–` (مثلاً `31:35`)
  - اعداد فارسی/لاتین هر دو مجاز
  -مجموعه ی کدگروه های ما اینها هستن:

`{،1،3،5،7،8،9،24،25،26،30،21،22،23،29،27،31،33،46،45،43،41،35،11،12،14،17،18،53،55،66،69،83،89}`

مثال: ورودی `27,31:35,41,43:46` در نظر بگیر
این یعنی: 27 – 31،33،35 (چون در مجموعه ما بین اعداد 31 تا 35 این سه عدد وجود دارد. پس معنی آن 31،32،33،34،35 نیست) – 41 – 43،45،46 (چون در مجموعه ما بیت اعداد 43 تا 46 همین سه رقم وجود دارد)

- توکن/کُد ناشناخته → ورود به `unseen_groups`.

------

## 8) ساخت سطرهای ماتریس (Cross-Product)

پس از عبور از R0:

### 8.1 مشترک

- ستون‌های پایه: «پشتیبان»، «مدیر»، «ردیف پشتیبان» (اگر باشد)
- مرکز: «مرکز گلستان صدرا» (0/1/2) و «مرکز گلستان صدرا3» (نام مرکز)
- «نام رشته»، «کدرشته»
- **مالی حکمت بنیاد**: برای **هر سطر** سه مقدار: 0/1/3

### 8.2 جنسیت

- اگر ستون «جنسیت» وجود دارد، از نگاشت 0=دختر، 1=پسر استفاده شود؛ در غیر این صورت خالی بماند.

### 8.3 **وضعیت تحصیلی (قاعدهٔ مهم)**

- **سطرهای عادی (Normal):** برای هر ترکیب، **دو نسخه** ساخته شود:
   `دانش آموز فارغ=1 (دانش‌آموز)` و `دانش آموز فارغ=0 (فارغ‌التحصیل)`.
- **سطرهای مدرسه‌ای (School):** همیشه **فقط** `دانش آموز فارغ=1` ساخته شود (فارغ‌التحصیل برای مدرسه‌ای مجاز نیست).
- **سطرهای دوگانه:** ترکیب دو قاعدهٔ بالا (هم Normal×2 و هم School×1).

### 8.4 قوانین Alias و مدرسه

- **Normal:** «عادی مدرسه=عادی»، «کد مدرسه/نام مدرسه=خالی»، **جایگزین=کدپستی 4رقمی پشتیبان**.
- **School:** «عادی مدرسه=مدرسه‌ای»، «کد مدرسه=کُد مدرسه»، «نام مدرسه=از SchoolReport»، **جایگزین=کد کارمندی پشتیبان**.

------

## 9) مرتب‌سازی و پایداری

پس از تولید همهٔ سطرها:

```
ORDER BY
  «مرکز گلستان صدرا» ASC,
  «کدرشته» ASC,
  COALESCE(«کد مدرسه», '999999') ASC,
  «جایگزین» ASC
```

سپس ستون شمارندهٔ پایدار `counter = 1..N` در ابتدای `matrix`.

------

## 10) اسکیمای خروجی

### 10.1 `matrix` (ترتیب ستون‌ها)

1. `counter`
2. `جایگزین`  (Normal=کدپستی 4رقمی؛ School=کد کارمندی پشتیبان)
3. `پشتیبان`
4. `مدیر`
5. `ردیف پشتیبان`
6. `نام رشته`
7. `کدرشته` (int)
8. `جنسیت` (0/1/خالی) + 15) `جنسیت2` (متنی)
9. `دانش آموز فارغ` (1/0) + 16) `دانش آموز فارغ2` (متنی)
10. `مرکز گلستان صدرا` (0/1/2) + 17) `مرکز گلستان صدرا3` (متنی)
11. `مالی حکمت بنیاد` (0/1/3)
12. `کد مدرسه`
13. `عادی مدرسه` («عادی»/«مدرسه‌ای»)
14. `نام مدرسه`

### 10.2 `validation`

```
total_rows`, `distinct_supporters`, `school_based_rows`,
 `finance_0_rows`, `finance_1_rows`, `finance_3_rows`,
 `removed_mentors`, `r0_skipped
```

### 10.3 شیت‌های تکمیلی

- `removed_mentors`: «پشتیبان»، «مدیر»، «تحت پوشش فعلی»، «ظرفیت خاص»، …، «دلیل حذف»
- `unmatched_schools`: `raw_school`, `supporter`, `manager`
- `unseen_groups`: `group_token`, `supporter`, `manager`
- `invalid_mentors`: `row_index`, `پشتیبان`, `مدیر`, `reason`
- `meta`: مسیر/نام ورودی‌ها، mtime، شمار ردیف‌ها، نسخهٔ اسکریپت/پیکربندی، پارامترهای اجرا

------

## 11) اعتبارسنجی با StudentReport (اختیاری)

### 11.1 سیاست جنسیت دیتاست

- اگر نام/مسیر فایل شامل **3570** باشد → **پسر**؛ اگر **3730** باشد → **دختر**.
- در غیر این صورت: اگر ستون «جنسیت» هست از آن استفاده شود؛ وگرنه پیش‌فرض **پسر**.
- قابل اجبار با `--students-gender {auto|male|female}`.

### 11.2 درخت تطبیق (Reason Tree)

1. تعیین نوع دانش‌آموز از «کد پستی دانش‌آموز»:
   - `<1000` → **school_by_schoolcode**
   - `1000..9999` → **normal_by_alias**
   - `>9999` یا غیرعددی → **school_by_mentorid**
2. فیلترها به‌ترتیب: **نوع** → **جنسیت** → **دانش‌آموز/فارغ** → **مرکز (از نام مدیر)** → **کدرشته**
3. Reason codes:
    `no normal alias match`, `no mentor-id school match`, `no school-code match`,
    `gender mismatch`, `status mismatch`, `center mismatch (manager-based)`, `group_code mismatch`
4. خروجی: `checks`, `breakdown`, `summary` (+ `unmatched_students.csv` در صورت نیاز)

------

## 12) فیلتر «امکان جذب» (اختیاری)

اگر ستون «امکان جذب دانش آموز» موجود باشد، فقط یکی از مقادیر حقیقتی زیر اجازهٔ ورود می‌گیرد (قابل‌پیکربندی):
 `بلی، بله، Yes، yes، 1، true، True`

------

## 13) مدیریت خطا/ناسازگاری

- نبود «کد کارمندی پشتیبان» → سطر در `invalid_mentors` ثبت و در ماتریس ساخته نمی‌شود.
- گم‌شدن ستون‌های ظرفیت → R0 Skip + `r0_skipped=1`.
- گروه/مدرسهٔ ناشناخته → از خروجی نریز؛ فقط در `unseen_groups`/`unmatched_schools` ثبت کن.
- ورودی‌های خالی → خروجی‌ها خالی ولی `meta` معتبر.

------

## 14) پیکربندی‌های قابل‌تغییر

- فعال/غیرفعال‌سازی R0
- نگاشت «نام مدیر→کُد مرکز»
- واریانت‌های مالی (پیش‌فرض 0/1/3)
- سیاست جنسیت دیتاست (auto/male/female)
- سطح لاگ
- **لیست truthy برای «امکان جذب»**
- **واژگان/هم‌معنی‌ها** (از شیت Synonyms)

------

## 15) راهنمای رفع `unseen_groups`

رخداد `unseen_groups` یعنی توکن/کُدی که اسکریپت در Crosswalk پیدا نکرده است. رایج‌ترین علل و راه‌حل‌ها:

1. **کُد ناموجود:** مثلاً `code:10` در Crosswalk ستونی با «کد گروه=10» ندارد → کُد را به Crosswalk اضافه/تصحیح کن.
2. **نام نوشتاری متفاوت:** «یازدهم شبکه و نرم‌افزار رایانه» ↔ «یازدهم شبکه و نرم افزار رایانه» → در شیت `Synonyms` هم‌معنی اضافه کن.
3. **غلط املایی/فاصله/کاراکترهای bidi:** ورودی را نرمال و تصحیح کن.
4. **اسم باکت (مثل «کل متوسطه 2») بدون تعریف:** باکت را در Crosswalk و/یا Synonyms تعریف کن.
5. **نام شیت اشتباه در Crosswalk:** باید دقیقاً «پایه تحصیلی (گروه آزمایشی)» باشد.

> بعد از اصلاحات، ماتریس را دوباره بساز؛ `unseen_groups` باید خالی یا فقط شامل موارد تازهٔ کشف‌شده باشد.

------

## 16) مثال‌های مرجع

**Normal-only**
 Inspactor: `کدپستی=1234`، `تعداد مدارس=0`، گروه=۲ مورد
 → برای هر گروه، **۲ وضعیت** (دانش‌آموز/فارغ) × **۳ مالی** = **۶ سطر** بدون مدرسه.

**School-only**
 Inspactor: `کدپستی=خالی`، `تعداد مدارس=2`، کُدها `210045` و `210099`
 → برای هر مدرسه و گروه، **فقط دانش‌آموز** × **۳ مالی** = **۳ سطر** به‌ازای هر مدرسه.

**Dual**
 Inspactor: `کدپستی=2345`، `تعداد مدارس=1`، کُد `210010`
 → Normal مانند مثال اول (برای هر گروه ۲×۳ سطر) **بعلاوه** School مانند مثال دوم (برای هر گروه ۱×۳ سطر).

------

## 17) پذیرش/قبول (Acceptance)

- پشتیبان **عادی** برای هر گروه، **دو وضعیت** تولید کند (دانش‌آموز و فارغ‌التحصیل).
- پشتیبان **مدرسه‌ای** فقط وضعیت **دانش‌آموز** داشته باشد.
- «جایگزین» در عادی=کدپستی 4رقمی؛ در مدرسه‌ای=کد کارمندی پشتیبان.
- مرتب‌سازی طبق §9 و `counter` افزوده شده باشد.
- `validation.r0_skipped` صحیح باشد.
- `unseen_groups`, `unmatched_schools`, `invalid_mentors` در صورت لزوم پر شوند.

------

## 18) غیرهدف‌ها (Out of Scope)

- انجام تخصیص نهایی دانش‌آموز به پشتیبان (این موتور فقط «احراز صلاحیت» می‌سازد).
- پاک‌سازی دادهٔ منبع (جز نرمال‌سازی برای تطبیق).

------

## 19) تغییرات (Changelog)

- **v1.0.2**
  - **قاعدهٔ وضعیت تحصیلی:** Normal ⇒ **دانش‌آموز + فارغ‌التحصیل**؛ School ⇒ **فقط دانش‌آموز**.
  - افزودن راهنمای رفع `unseen_groups` و مشخصات کامل ستون «شامل گروه‌های آزمایشی» (Comma/Range، ارقام فارسی/لاتین).
  - گسترش لیست truthy برای «امکان جذب»: `true/True` اضافه شد.
  - صیقل واژگان/تعاریف و پذیرش دقیق‌تر.
- **v1.0.1**
  - الزام «کد کارمندی پشتیبان» به‌عنوان معیار یگانه؛ افزودن شیت `invalid_mentors`.
  - تثبیت قواعد «عادی/مدرسه‌ای/دوگانه»، مرتب‌سازی قطعی + `counter`, `r0_skipped`.
  - شفاف‌سازی ولیدیشن سه‌حالته بر پایهٔ «کد پستی دانش‌آموز» و سیاست 3570/3730.

------

### چک‌لیست QA

- ستون‌های الزامی ورودی‌ها موجود است (به‌خصوص «کد کارمندی پشتیبان»)
- R0 اجرا یا `r0_skipped=1` ثبت شده است
- نوع پشتیبان (Normal/School/Dual) درست تشخیص داده می‌شود
- برای Normal، **دو وضعیت** ساخته می‌شود؛ برای School، **فقط دانش‌آموز**
- Alias در Normal/School مطابق §8.4
- `unseen_groups` و `unmatched_schools` فقط موارد واقعی را دارند
- مرتب‌سازی و `counter` صحیح است
- اگر ولیدیشن اجرا شد، Reason Tree و آمار منطقی است

------


