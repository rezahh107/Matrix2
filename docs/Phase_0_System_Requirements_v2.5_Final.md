# Phase 0 System Requirements — Smart Student Allocation (v2.5 Final)

## 1. مقدمه و دامنه
- این سند الزامات فاز ۰ سیستم تخصیص دانش‌آموزان را با تکیه بر Policy v1.0.3، SSoT v1.0.2 و معماری Core/Infra/UI تعریف می‌کند.
- دامنه شامل منطق Policy-First، لایهٔ Infra برای I/O (WordPress، Excel، HistoryStore) و رابط PySide6/CLI است؛ تغییر سیاست رتبه‌بندی یا ۶ کلید Join در این نسخه مجاز نیست.
- هدف، افزودن رفتار تاریخچه‌محور (HistoryStore + `dedupe_by_national_id`) و کانال‌محور (AllocationChannel) بدون نقض تعیین‌گرایی و شفافیت است.

## 2. الزامات عملکردی (Functional Requirements)
### 2.1 مدیریت تاریخچه و جلوگیری از تخصیص تکراری
- **FR-HIST-01 — نگهداری HistoryStore:** Infra باید انباره‌ای پایدار از تخصیص‌های قطعی بسازد که با کلید `national_id_normalized` و ۶ کلید Join (همگی `int`) قابل جست‌وجو باشد. داده‌های حداقلی شامل `mentor_id`, `allocation_date`, `کد مدرسه`, `مرکز گلستان صدرا`, `gender`, `graduation_status`, `allocation_channel` و نشان نسخهٔ policy/ssot است. این مخزن در هر اجرا خوانده و پس از تخصیص‌های جدید به‌صورت افزایشی به‌روزرسانی می‌شود.
- **FR-HIST-02 — دِداپ مبتنی بر کد ملی:** Core باید قبل از هرگونه رتبه‌بندی، تابع خالص `dedupe_by_national_id` را اجرا کند تا ورودی‌ها به دو گروه «allocated_before» (دارای سابقه معتبر در HistoryStore) و «new_candidates» تفکیک شوند. نرمال‌سازی اعداد فارسی/لاتین، صفر پیشرو و حذف نویز در همین مرحله انجام می‌شود و نتیجهٔ آن باید در trace/خلاصه ثبت شود.
- **FR-HIST-03 — دلیل تصمیم:** برای هر دانش‌آموزی که از جریان تخصیص حذف می‌شود، باید مقدار `dedupe_reason` (مثلاً «کد ملی نامعتبر»، «تخصیص قبلی» یا «بدون سابقه») در trace و خروجی QA موجود باشد تا اپراتور بتواند تصمیم را توضیح دهد.

### 2.2 کانال‌های تخصیص سیاست‌محور
- **FR-CHAN-01 — پشتیبانی AllocationChannelConfig:** PolicyConfig باید شامل بخش AllocationChannelConfig باشد و Core موظف است بدون هاردکد شناسه، مقدار `allocation_channel` را از بین چهار مقدار SCHOOL / GOLESTAN / SADRA / GENERIC برای هر دانش‌آموز محاسبه کند. قواعد تصمیم‌گیری می‌تواند از ترکیب `کد مدرسه`, `مرکز گلستان صدرا`, `مرکز ثبت‌نام` و وضعیت تحصیلی استفاده کند ولی باید همگی از PolicyConfig خوانده شوند.
- **FR-CHAN-02 — کانال در trace/export:** مقدار `allocation_channel` برای تمام دانش‌آموزان (چه تخصیص‌یافته چه ردشده) باید در trace، خلاصهٔ مدیریتی و خروجی ImportToSabt/Excel قابل مشاهده باشد تا تحلیل جریان‌ها و مقایسهٔ کانال‌ها ممکن شود.
- **FR-CHAN-03 — همزیستی با سیاست رتبه‌بندی:** اجرای کانال‌ها نباید ترتیب رتبه‌بندی را تغییر دهد؛ پس از تعیین کانال، همان سیاست ثابت `occupancy_ratio → allocations_new → mentor_id` با sort طبیعی/پایدار اجرا می‌شود. هرگونه استثناء باید در PolicyConfig تعریف شود، نه در Core.

### 2.3 گزارش‌پذیری و خروجی‌ها
- **FR-TRACE-01 — غنی‌سازی Trace:** trace هشت‌مرحله‌ای باید علاوه‌بر شمارش‌های استاندارد، ستون‌های `allocation_channel`, `dedupe_reason`, `allocated_before` را شامل شود تا اپراتور بتواند تصمیم تاریخچه/کانال را در کنار فیلترهای اصلی مشاهده کند.
- **FR-EXPORT-01 — همگام‌سازی با HistoryStore:** پس از ثبت تخصیص‌های موفق در خروجی ImportToSabt، همان رکوردها باید به HistoryStore اضافه شوند تا اجرای بعدی دقیقاً همان آگاهی تاریخچه‌ای را داشته باشد. این فرآیند باید اتمیک و مقاوم در برابر شکست نیمه‌راه باشد.

### 2.4 جدول مرجع کانال‌ها (اطلاعات تجمیعی)
| کانال | توصیف سیاستی | ورودی‌های محتمل |
|-------|---------------|------------------|
| SCHOOL | دانش‌آموزانی که مطابق PolicyConfig به مدرسهٔ مشخص متصل‌اند و باید در همان جریان مدرسه‌ای توضیح داده شوند. | `کد مدرسه`, وضعیت مدرسه در PolicyConfig |
| GOLESTAN | جریان ثبت‌نام مراکز گلستان (WordPress/Gravity Forms) که مستقیم از مرکز گلستان به پشتیبان می‌رسند. | `مرکز گلستان صدرا`, فیلدهای ثبت‌نام گلستان |
| SADRA | درخواست‌های مرکز صدرا که از PolicyConfig کانال ویژه دریافت می‌کنند تا ظرفیت و گزارش مجزا داشته باشند. | `مرکز گلستان صدرا` با مقدارهای صدرا، فیلدهای مالی حکمت بنیاد |
| GENERIC | سایر دانش‌آموزان که در PolicyConfig به جریان عمومی هدایت می‌شوند؛ همان سیاست رتبه‌بندی مشترک را طی می‌کنند. | همهٔ مواردی که در سه کانال دیگر قرار نمی‌گیرند |

## 3. الزامات غیرعملکردی و کیفی (Non-Functional Requirements)
- **NFR-DET-01 — تعیین‌گرایی:** ورودی مساوی، خروجی مساوی؛ همهٔ sort ها (به‌ویژه رتبه‌بندی mentors) باید stable + natural باشند. تاریخچه و کانال نباید منجر به رفتار غیرقابل‌پیش‌بینی شوند.
- **NFR-JOIN-01 — کلیدهای ثابت:** شش کلید Join (`کدرشته`, `جنسیت`, `دانش آموز فارغ`, `مرکز گلستان صدرا`, `مالی حکمت بنیاد`, `کد مدرسه`) باید همیشه `int` باقی بمانند و در HistoryStore/trace/export بدون تغییر معنا ذخیره شوند.
- **NFR-POLICY-01 — Policy-First:** تمام قواعد تاریخچه و کانال باید از PolicyConfig/AllocationChannelConfig خوانده شوند؛ Core اجازهٔ هاردکد شناسه مدرسه/مرکز یا استثناء جدید ندارد.
- **NFR-TRACE-01 — قابلیت ردیابی:** برای هر دانش‌آموز باید امکان بازسازی مسیر تصمیم وجود داشته باشد (policy_version، ssot_version، allocation_channel، dedupe_reason، ظرفیت و Mentor انتخاب‌شده). خروجی QA باید امکان فیلتر روی هر کدام از این فیلدها را بدهد.
- **NFR-RESILIENCE-01 — خطایابی:** اگر HistoryStore در دسترس نباشد یا ناسازگار باشد، Infra باید خطای واضح تولید کند و تخصیص متوقف شود؛ استفاده از تاریخچه ناقص یا حدسی مجاز نیست.
- **NFR-UX-01 — هماهنگی UI/CLI:** UI/CLI باید پیام‌های مرتبط با تاریخچه/کانال را از Core دریافت و بدون تغییر معنی به کاربر نمایش دهند (مثلاً شمارش دانش‌آموزان خارج‌شده به‌دلیل تاریخچه یا کانال خاص).

## 4. ردیابی الزامات به معماری و Vision
- FR-HIST-01/02/03 توسط زیربخش «HistoryStore و `dedupe_by_national_id`» در Architecture Blueprint و بخش «حافظهٔ تخصیص» در Vision پشتیبانی می‌شوند.
- FR-CHAN-01/02/03 و جدول کانال‌ها با زیربخش AllocationChannel در Architecture و بخش «کانال‌های جریان دانش‌آموز» در Vision هم‌راستا هستند.
- NFR-DET-01, NFR-JOIN-01, NFR-POLICY-01 با Invariants Vision و بخش Determinism معماری همخوان است؛ Trace و Explainability نیز در هر سه سند تکرار شده‌اند تا سازگاری تضمین شود.
