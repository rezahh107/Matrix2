# راهنمای کامل اجرای سامانه تخصیص دانشجو-منتور در ویندوز

## 1. مقدمه
این سامانه یک ابزار رومیزی برای ساخت ماتریس احراز صلاحیت و تخصیص دانش‌آموزان به منتور است که بر اساس سیاست‌های نسخه ۱.۰.۳ پیاده‌سازی شده است. رابط کاربری PySide6 با محوریت یک پنجره اصلی شامل نوار وضعیت، نوار پیشرفت، گزارش متنی و دکمهٔ اجرای سناریو طراحی شده تا روندهای طولانی‌مدت را بدون فریز شدن UI نمایش دهد.【F:app/ui/main_window.py†L25-L104】 این راهنما ویژه ویندوز ۱۰ و ۱۱ است و کاربرانی را هدف قرار می‌دهد که می‌خواهند برنامه را بر روی یک لپ‌تاپ یا رایانه اداری بدون دانش عمیق برنامه‌نویسی اجرا کنند. اگر به دنبال تولید خروجی‌های رسمی Policy یا پیگیری خطاها هستید، این سند نقشهٔ راه گام‌به‌گام را در اختیار شما قرار می‌دهد.

## 2. نصب و راه‌اندازی
### 2.1 پیش‌نیازها
- **ویندوز ۱۰ یا ۱۱** (۶۴بیتی) با دسترسی نصب نرم‌افزار.
- **Python 3.11** یا جدیدتر همراه با pip. پیشنهاد می‌شود بستهٔ «Microsoft Visual C++ Redistributable» نصب باشد تا وابستگی‌های PySide6 بدون خطا نصب شوند.
- حداقل **۴ گیگابایت RAM** و **۱ گیگابایت فضای خالی دیسک** برای فایل‌های ورودی/خروجی Excel.

### 2.2 دریافت کد
1. آخرین نسخه مخزن را از کنترل نسخه داخلی یا GitHub دانلود و در یک مسیر بدون فاصله (مثلاً `C:\MatrixApp`) استخراج کنید.
2. پنجره PowerShell یا Windows Terminal را در همان مسیر باز کنید.

### 2.3 ساخت محیط مجازی و نصب وابستگی‌ها
1. ایجاد محیط مجازی:
   ```powershell
   python -m venv .venv
   .\.venv\Scripts\Activate.ps1
   ```
2. به‌روزرسانی pip و نصب کتابخانه‌ها:
   ```powershell
   python -m pip install --upgrade pip
   pip install -r requirements.txt
   ```
   این فایل وابستگی‌هایی مانند PySide6، pandas، openpyxl، numpy و PyYAML را مشخص می‌کند که برای UI، پردازش داده و نوشتن Excel ضروری‌اند.【F:requirements.txt†L1-L7】
3. (اختیاری) برای ساخت فایل اجرایی مستقل، PyInstaller را نیز نصب کنید:
   ```powershell
   pip install pyinstaller
   ```

### 2.4 تست سریع نصب
پس از نصب، فرمان زیر باید بدون خطا راهنمای خط فرمان برنامه را نمایش دهد:
```powershell
python -m app.infra.cli --help
اگر پیام راهنما نمایش داده نشد یا خطای ModuleNotFoundError دریافت کردید، مطمئن شوید مرحلهٔ فعال‌سازی `.venv` را انجام داده‌اید.

## 3. پیکربندی اولیه
### 3.1 سیاست‌های اجرایی (`config/policy.json`)
فایل `config/policy.json` مرجع اصلی سیاست است و باید قبل از اجرای سناریوها بررسی شود.【F:config/policy.json†L1-L27】 مهم‌ترین کلیدها:
- `version`: شماره نسخه سیاست که باید با سند سازمان همخوانی داشته باشد.
- `join_keys`: ستون‌های ضروری برای الحاق داده‌ها؛ مطمئن شوید در ورودی‌های Excel دقیقاً با همین نام و نوع عددی ذخیره شده‌اند.
- `ranking_rules`: ترتیب اولویت‌دهی به منتورها (نسبت اشغال، تعداد تخصیص جدید، شناسهٔ طبیعی).
- `trace_stages`: مراحل ثبت ردپای تصمیم‌گیری برای گزارش Explainability.
در صورت نیاز به تغییر، با ویرایشگر متنی UTF-8 مقدار کلیدها را به‌روزرسانی و سپس اعتبارسنجی ساختار JSON را با ابزارهایی مانند `python -m json.tool config/policy.json` انجام دهید.

### 3.2 تنظیمات لاگ (`config/logging.yaml`)
برای کنترل سطح لاگ و مسیر فایل‌ها از `config/logging.yaml` استفاده می‌شود.【F:config/logging.yaml†L1-L27】 به‌صورت پیش‌فرض:
- لاگ‌ها علاوه‌بر کنسول، در `logs/app.log` ذخیره می‌شوند.
- حجم هر فایل لاگ به ۱ مگابایت محدود و حداکثر ۵ نسخهٔ پشتیبان نگهداری می‌شود.
در صورت اجرای برنامه روی سیستم‌هایی با محدودیت دسترسی، مطمئن شوید پوشهٔ `logs` وجود دارد یا مسیر دیگری تعریف کنید.

### 3.3 تنظیمات کاربر و فایل‌های اخیر
ماژول `SettingsManager` اطلاعاتی مانند آخرین مسیر خروجی، ظرفیت‌های دلخواه و فایل‌های اخیر را در رجیستری ویندوز (یا فایل INI) ذخیره می‌کند.【F:app/utils/settings_manager.py†L14-L288】 اگر برنامه روی چند حساب کاربری اجرا می‌شود، برای انتقال تنظیمات از گزینهٔ پشتیبان‌گیری JSON داخلی (`export_to_file`) استفاده کنید. مقداردهی پیش‌فرض مانند `max_occupancy=0.95` یا `enable_capacity_gate=True` را می‌توان از طریق API سطح کد یا توسعهٔ فرم‌های تنظیمات تغییر داد.

### 3.4 آماده‌سازی داده‌های Excel
- فایل‌های **Inspactor** و **School** باید شیت هدف خود را در اولین صفحه داشته باشند؛ تابع `read_excel_first_sheet` همین شیت نخست را می‌خواند.【F:app/infra/io_utils.py†L93-L118】
- فایل **Crosswalk** باید شیتی با عنوان دقیق «پایه تحصیلی (گروه آزمایشی)» داشته باشد و در صورت وجود شیت «Synonyms» به‌طور خودکار خوانده می‌شود.【F:app/infra/io_utils.py†L120-L150】
برای جلوگیری از خطاهای زمان اجرا، نام شیت‌ها و ستون‌ها را قبل از اجرا بررسی کنید.

## 4. اجرا از طریق رابط کاربری (UI)
### 4.1 راه‌اندازی برنامه
در PowerShell فعال‌شده، فرمان زیر را اجرا کنید:
```powershell
python -m app.main
```
این دستور همان چیزی است که در README پروژه توصیه شده و حلقهٔ اصلی PySide6 را راه‌اندازی می‌کند.【F:README.md†L3-L13】

### 4.2 مدیریت نمونه‌های هم‌زمان
در شروع، کلاس `SingleInstanceGuard` بررسی می‌کند که برنامه قبلاً اجرا نشده باشد و در صورت وجود نمونهٔ دیگر پیام هشدار نمایش می‌دهد.【F:app/main.py†L65-L170】 اگر پیام «برنامه در حال اجرا» دریافت کردید، ابتدا نمونهٔ قبلی را ببندید یا از Task Manager کمک بگیرید.

### 4.3 اجزای پنجره اصلی
پنجرهٔ اصلی چهار بخش دارد：【F:app/ui/main_window.py†L28-L50】
1. **برچسب وضعیت**: پیام‌های متنی (مثلاً «آماده»، «در حال ساخت ماتریس»).
2. **نوار پیشرفت**: بازهٔ ۰ تا ۱۰۰ درصد که هنگام پیشروی تسک به‌روزرسانی می‌شود.
3. **گزارش متنی (Log)**: هر پیام پیشرفت یا خطا در این بخش ثبت می‌شود و برای ممیزی مفید است.
4. **دکمهٔ «اجرای تست»**: یک سناریوی ساختگی را اجرا می‌کند تا صحت ارتباط Worker با UI سنجیده شود.

### 4.4 اجرای سناریوی تست
با کلیک بر «اجرای تست»، یک Worker در پس‌زمینه راه‌اندازی می‌شود که چهار مرحلهٔ پیشرفت (۰، ۳۰، ۶۰ و ۱۰۰ درصد) را منتشر می‌کند.【F:app/ui/main_window.py†L84-L94】 پیام‌ها هم در نوار وضعیت و هم در گزارش متنی ثبت خواهند شد. این گام برای اطمینان از درست بودن نصب PySide6 و عملکرد Threadها پیش از اجرای سناریوهای حجیم توصیه می‌شود.

### 4.5 اجرای سناریوهای واقعی با UI
برای پیاده‌سازی سناریوهای واقعی (مثلاً ساخت ماتریس)، می‌توانید یک تابع بلندمدت را با امضای `func(*args, progress=callable)` به `run_task` بدهید تا به‌صورت ناهمگام اجرا شود.【F:app/ui/main_window.py†L53-L82】【F:app/ui/task_runner.py†L26-L79】 نمونهٔ پایه:
```python
from functools import partial
from app.ui.main_window import MainWindow
from app.infra import cli

window = MainWindow()
args = [
    "build-matrix",
    "--inspactor", "C:/data/Inspactor.xlsx",
    "--schools", "C:/data/Schools.xlsx",
    "--crosswalk", "C:/data/Crosswalk.xlsx",
    "--output", "C:/out/matrix.xlsx",
]
window.run_task(partial(cli.main, args))
```
این الگو نشان می‌دهد چگونه می‌توان فرم‌های انتخاب فایل را به تابعی متصل کرد که همان فرمان‌های خط فرمان را اجرا می‌کند و پیشرفت را به UI مخابره می‌نماید. توسعه‌دهندگان می‌توانند این کد را در اسلات‌های دکمه‌های جدید قرار دهند.

### 4.6 بستن ایمن برنامه
در هنگام بستن پنجره، اگر هنوز کاری در حال اجرا باشد، درخواست لغو صادر و تا سه ثانیه منتظر خاتمهٔ Worker می‌ماند تا از فساد داده جلوگیری شود.【F:app/ui/main_window.py†L96-L103】

## 5. اجرا از طریق خط فرمان (CLI) – اختیاری
رابط CLI برای اتوماسیون بدون UI طراحی شده است و دو زیرفرمان اصلی دارد.【F:app/infra/cli.py†L1-L217】
- **ساخت ماتریس**:
  ```powershell
  python -m app.infra.cli build-matrix \`
    --inspactor C:\data\Inspactor.xlsx \`
    --schools C:\data\Schools.xlsx \`
    --crosswalk C:\data\Crosswalk.xlsx \`
    --output C:\out\eligibility_matrix.xlsx
  ```
  خروجی شامل شیت‌های `matrix`، `validation`، `removed` و گزارش‌های کمکی است.【F:app/infra/cli.py†L53-L115】
- **تخصیص دانش‌آموزان**:
  ```powershell
  python -m app.infra.cli allocate \`
    --students C:\data\students.xlsx \`
    --pool C:\data\mentor_pool.xlsx \`
    --output C:\out\allocations.xlsx
  ```
  این فرمان فایل Excel با شیت‌های `allocations`، `updated_pool`، `logs` و `trace` تولید می‌کند.【F:app/infra/cli.py†L119-L212】
هر دو زیرفرمان پارامتر `--policy` را هم می‌پذیرند تا در صورت نیاز به نسخهٔ سفارشی سیاست اشاره کنید.

## 6. رفع مشکلات رایج
### 6.1 خطاهای نصب
- **ModuleNotFoundError: PySide6** – محیط مجازی فعال نشده یا نصب ناقص است؛ دوباره `pip install -r requirements.txt` را اجرا کنید.【F:requirements.txt†L1-L7】
- **RuntimeError: هیچ‌کدام از 'openpyxl' یا 'xlsxwriter' نصب نیستند** – برای نوشتن Excel باید یکی از این دو کتابخانه حاضر باشد؛ با `pip install openpyxl xlsxwriter` مشکل رفع می‌شود.【F:app/infra/io_utils.py†L37-L90】

### 6.2 خطاهای داده
- **شیت Crosswalk یافت نشد** – پیام «شیت «پایه تحصیلی (گروه آزمایشی)» در Crosswalk یافت نشد» نشان می‌دهد عنوان شیت یا محل فایل اشتباه است؛ فایل را بازبینی و نام دقیق شیت را اصلاح کنید.【F:app/infra/io_utils.py†L136-L146】
- **کلیدهای الحاق نامعتبر** – اگر ساخت ماتریس متوقف شد، ستون‌های `join_keys` را در Excel به فرمت عددی (بدون کاراکتر اضافی) تبدیل کنید.【F:config/policy.json†L5-L26】

### 6.3 خطاهای اجرا در UI
- **پیغام «برنامه در حال اجراست»** – نمونهٔ دیگری فعال است؛ آن را ببندید یا سیستم را ری‌استارت کنید.【F:app/main.py†L133-L170】
- **ظاهر نشدن نوار پیشرفت** – اطمینان حاصل کنید تابع طولانی پارامتر `progress(pct, message)` را فراخوانی می‌کند؛ در غیر این صورت UI بروزرسانی نمی‌شود.【F:app/ui/task_runner.py†L58-L79】

### 6.4 لاگ و گزارش خطا
همهٔ خطاهای بحرانی علاوه‌بر پیام گرافیکی در فایل `app.log` نیز ثبت می‌شوند که در صورت نیاز می‌توان آن را برای تیم پشتیبانی ارسال کرد.【F:app/main.py†L25-L35】【F:config/logging.yaml†L8-L24】

## 7. مستندات فنی تکمیلی (اختیاری)
- **Pipeline سیاست‌محور**: اجرای `build_matrix` و `allocate_batch` مطابق Policy نسخه ۱.۰.۳ انجام می‌شود و تمام مراحل Trace در خروجی‌های `meta` و `trace` ثبت می‌شوند.【F:app/infra/cli.py†L53-L212】【F:config/policy.json†L13-L27】
- **اجرای غیرهمزمان**: کلاس `Worker` در `app/ui/task_runner.py` تضمین می‌کند که همهٔ توابع Core بدون بلوکه کردن UI اجرا شوند و درخواست لغو را پشتیبانی کنند.【F:app/ui/task_runner.py†L26-L79】
- **تنظیمات کاربر**: برای ادغام با فرم‌های پیشرفته می‌توان از `AppPreferences` استفاده کرد تا آخرین مسیرهای انتخاب‌شده در دیسک ذخیره و بازیابی شوند.【F:app/utils/settings_manager.py†L159-L288】

## 8. جمع‌بندی و به‌روزرسانی‌های آینده
برای اجرای موفق در ویندوز این مراحل را به‌ترتیب دنبال کنید: نصب وابستگی‌ها، کنترل سیاست و تنظیمات، آماده‌سازی فایل‌های Excel، اجرای برنامه با UI و در صورت نیاز استفاده از CLI. پایش لاگ‌ها و اجرای سناریوی تست قبل از هر عملیات اصلی باعث کاهش خطاهای زمان اجرا می‌شود. در به‌روزرسانی‌های آینده معمولاً نسخهٔ سیاست (`policy_version`) و وابستگی‌ها تغییر می‌کنند؛ بنابراین پس از دریافت نسخهٔ جدید، حتماً `pip install -r requirements.txt` را مجدداً اجرا کرده و `config/policy.json` را با نسخهٔ جدید جایگزین کنید تا با SSoT هماهنگ بمانید.【F:requirements.txt†L1-L7】【F:config/policy.json†L1-L27】
