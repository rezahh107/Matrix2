# سند مادر هسته سیستم تخصیص دانش‌آموزان — نسخه 2.0

## پوشش ماتریس (matrix.coverage)
- کلیدهای پیوست برای سنجش پوشش دقیقاً شش‌گانهٔ Policy هستند: «کدرشته»، «جنسیت»، «دانش آموز فارغ»، «مرکز گلستان صدرا»، «مالی حکمت بنیاد»، «کد مدرسه».
- مخرج پوشش از گروه‌های منتور ساخته می‌شود که پس از فیلتر alias/capacity قابل تولید سطر هستند. حالت مخرج از `matrix.coverage.denominator_mode` در policy.json کنترل می‌شود:
  - `mentors`: فقط گروه‌های قابل‌تولید از منتورها.
  - `mentors_students_intersection`: اشتراک گروه‌های قابل‌تولید با گروه‌های دانش‌آموز.
  - `mentors_students_union`: اجتماع دو فضا.
- پارامتر `matrix.coverage.include_blocked_candidates_in_denominator` مشخص می‌کند گروه‌های مسدود (فاقد alias/ظرفیت) فقط گزارش شوند یا در مخرج بیایند.
- شمارندهٔ `invalid_group_token_count` صرفاً توکن‌های نامعتبر (گروه‌های مفقود/نامچسبیده) را ثبت می‌کند و در مخرج پوشش وارد نمی‌شود.
- `unseen_group_count` اکنون فقط گروه‌های «viable» بدون سطر ماتریس را شامل می‌شود تا نسبت پوشش متکی بر گروه‌های قابل تحقق باقی بماند.
- فیلدهای validation/meta (coverage_ratio، unseen_group_count، invalid_group_token_count، coverage_denominator_groups، unmatched_school_count) مستقیم از CoverageMetrics پر می‌شوند و در هیچ مرحله‌ای دوباره محاسبه نمی‌شوند.
- فرمول پوشش: `coverage_ratio = covered_groups / total_groups` که در آن `total_groups` صرفاً گروه‌های in_coverage_denominator (پیش‌فرض mentor-only) است؛ `invalid_group_token_count` و `unmatched_school_count` فقط برای دیباگ گزارش می‌شوند و مخرج را تغییر نمی‌دهند.

## مرحلهٔ ۰: ساخت استخر پشتیبان‌ها (BuildMentorPool)
- Core پیش از ساخت ماتریس، یک مرحلهٔ جداگانه برای دریافت دادهٔ Mentors از Infra و اتصال آن به **MentorProfile** اجرا می‌کند. در این مرحله هیچ فایل یا شبکه‌ای خوانده نمی‌شود؛ فقط DataFrameهایی که Infra تحویل داده است مصرف می‌شوند.
- MentorProfile شامل `mentor_id`, ظرفیت‌های اعلام‌شده، مدیر بالادستی، متادیتای trace (مثلاً occupancy_ratio) و فیلد `mentor_status` است. Core هیچ نام یا شناسه‌ای را هاردکد نمی‌کند و صرفاً به همین ستون‌ها که از Policy/SSoT آمده‌اند اعتماد دارد.
- منطق فیلتر:
  1. ادغام دادهٔ InspactorReport با MentorProfile برای به‌دست‌آوردن وضعیت هر ردیف.
  2. حذف کامل تمام ردیف‌هایی که `mentor_status = FROZEN` دارند؛ این افراد حتی به مرحلهٔ محاسبهٔ ظرفیت/alias نمی‌رسند.
  3. در صورت وجود حالات `RESTRICTED_*`, شناسه‌های محدودشده در استخر باقی می‌مانند ولی constraint آن‌ها به قید eligibility در مرحلهٔ ماتریس تبدیل می‌شود (مثلاً فقط یک مدرسه یا کانال).
- خروجی این مرحله DataFrame پاکی است که فقط MentorGroupهای `ACTIVE` را شامل می‌شود؛ تمام شاخص‌های coverage و مراحل بعدی روی همین مجموعه اجرا می‌شوند، بنابراین تغییر وضعیت در Policy فوراً روی استخر اثر می‌گذارد.
- اگر MentorProfile یک پشتیبان جدید را معرفی کند که در InspactorReport وجود ندارد، Core او را نادیده می‌گیرد و صرفاً هشدار می‌دهد؛ بالعکس، اگر InspactorReport کسی را معرفی کند که در Policy با وضعیت `FROZEN` مشخص است، نتیجهٔ BuildMentorPool همچنان او را حذف می‌کند و trace علت را گزارش می‌کند.

## نکات تاریخچه و کانال
- HistoryStore همچنان تنها منبع سابقهٔ تخصیص است و ممکن است بر اساس الگوهای ظرفیت (مثلاً تعداد سالانهٔ تخصیص‌ها) به اپراتور پیشنهاد دهد پشتیبانی را `FROZEN` یا `RESTRICTED` کند، اما تا زمانی که mentor_status در Policy/SSoT تغییر نکند، Core رفتاری را عوض نمی‌کند.
- AllocationChannel همچنان فقط مسیر پردازش دانش‌آموزان را مشخص می‌کند و هیچ‌گاه جایگزین mentor_status نمی‌شود؛ ابتدا BuildMentorPool روی mentors اعمال می‌شود، سپس ماتریس و کانال‌ها بر اساس همان مجموعه ساخته می‌شوند.
