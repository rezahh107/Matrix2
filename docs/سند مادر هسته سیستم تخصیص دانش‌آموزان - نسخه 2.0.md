# سند مادر هسته سیستم تخصیص دانش‌آموزان — نسخه 2.0

## پوشش ماتریس (matrix.coverage)
- کلیدهای پیوست برای سنجش پوشش دقیقاً شش‌گانهٔ Policy هستند: «کدرشته»، «جنسیت»، «دانش آموز فارغ»، «مرکز گلستان صدرا»، «مالی حکمت بنیاد»، «کد مدرسه».
- مخرج پوشش از گروه‌های منتور ساخته می‌شود که پس از فیلتر alias/capacity قابل تولید سطر هستند. حالت مخرج از `matrix.coverage.denominator_mode` در policy.json کنترل می‌شود:
  - `mentors`: فقط گروه‌های قابل‌تولید از منتورها.
  - `mentors_students_intersection`: اشتراک گروه‌های قابل‌تولید با گروه‌های دانش‌آموز.
  - `mentors_students_union`: اجتماع دو فضا.
- پارامتر `matrix.coverage.include_blocked_candidates_in_denominator` مشخص می‌کند گروه‌های مسدود (فاقد alias/ظرفیت) فقط گزارش شوند یا در مخرج بیایند.
- شمارندهٔ `invalid_group_token_count` صرفاً توکن‌های نامعتبر (گروه‌های مفقود/نامچسبیده) را ثبت می‌کند و در مخرج پوشش وارد نمی‌شود.
- `unseen_group_count` اکنون فقط گروه‌های «viable» بدون سطر ماتریس را شامل می‌شود تا نسبت پوشش متکی بر گروه‌های قابل تحقق باقی بماند.
- فیلدهای validation/meta (coverage_ratio، unseen_group_count، invalid_group_token_count، coverage_denominator_groups، unmatched_school_count) مستقیم از CoverageMetrics پر می‌شوند و در هیچ مرحله‌ای دوباره محاسبه نمی‌شوند.
- فرمول پوشش: `coverage_ratio = covered_groups / total_groups` که در آن `total_groups` صرفاً گروه‌های in_coverage_denominator (پیش‌فرض mentor-only) است؛ `invalid_group_token_count` و `unmatched_school_count` فقط برای دیباگ گزارش می‌شوند و مخرج را تغییر نمی‌دهند.

## مرحلهٔ ۰: ساخت استخر پشتیبان‌ها (BuildMentorPool)
- **پیاده‌سازی Policy-First:** Core اکنون mentor_pool_governance را از `policy.json` می‌خواند و تنها منتورهای با `mentor_status=active` را وارد استخر می‌کند. ورودی اختیاری `overrides` (نقشهٔ نوبتی mentor_id→enabled) می‌تواند از UI/CLI تزریق شود اما در Core هیچ وابستگی به Qt/I/O وجود ندارد.
- Core پیش از ساخت ماتریس، یک مرحلهٔ جداگانه برای دریافت دادهٔ ادغام‌شدهٔ Mentors و **MentorProfile** از Infra اجرا می‌کند. در این مرحله هیچ فایل یا شبکه‌ای خوانده نمی‌شود؛ فقط DataFrameهایی که Infra تحویل داده است مصرف می‌شوند.
- MentorProfile شامل `mentor_id`, ظرفیت‌های اعلام‌شده، مدیر بالادستی، متادیتای trace (مثلاً occupancy_ratio) و فیلد `mentor_status` است. Core هیچ نام یا شناسه‌ای را هاردکد نمی‌کند و صرفاً به همین ستون‌ها که از Policy/SSoT آمده‌اند اعتماد دارد.
- منطق فیلتر:
  1. حذف کامل تمام ردیف‌هایی که `mentor_status = inactive` دارند؛ این افراد حتی به مرحلهٔ محاسبهٔ ظرفیت/alias نمی‌رسند.
  2. overrideهای فعال/غیرفعال در هر اجرا بعد از Policy اعمال می‌شوند تا UI/CLI بتواند به‌صورت دترمینیستیک اعضای استخر را برای همان اجرا تغییر دهد.
- خروجی این مرحله DataFrame پاکی است که فقط MentorGroupهای `active` را شامل می‌شود؛ تمام شاخص‌های coverage و مراحل بعدی روی همین مجموعه اجرا می‌شوند، بنابراین تغییر وضعیت در Policy فوراً روی استخر اثر می‌گذارد.
- این مرحله هیچ تغییری در ۶ کلید Join یا سیاست رتبه‌بندی `occupancy_ratio → allocations_new → mentor_id` ایجاد نمی‌کند؛ mentor_status فقط تعیین می‌کند چه کسانی به ماتریس راه پیدا می‌کنند و دترمینیسم را پیش از شروع فیلترهای صلاحیت تضمین می‌کند.

## QA invariants (QA_RULE_*)
- Core پس از ساخت ماتریس و تخصیص، `run_all_invariants(...)` را در `app/core/qa/invariants.py` روی خروجی‌های درون‌حافظه اجرا می‌کند تا هر تخطی به‌صورت `QaViolation` ثبت و نتیجهٔ QA به‌صورت قطعی تعیین شود.
- شناسه‌های قوانین QA پایدارند (QA_RULE_*) و در مستندات/Policy/کد مشترک استفاده می‌شوند.

### QA_RULE_STU_01 — هم‌خوانی شمارش جهانی دانش‌آموز
- **ورودی‌ها:** ماتریس (matrix)، فایل تخصیص (allocation)، StudentReport.
- **Invariant:** تعداد دانش‌آموز در هر ورودی شناخته‌شده یکسان است (با تشخیص ستون `student_id` در صورت وجود).
- **Failure:** هر اختلاف در شمارش → QaViolation با جزئیات counts و وضعیت `FAILED_QA`.

### QA_RULE_STU_02 — هم‌خوانی شمارش دانش‌آموز به ازای منتور
- **ورودی‌ها:** allocation، InspactorReport (ستون‌های شمار مورد انتظار).
- **Invariant:** برای هر mentor_id، مقدار `expected_student_count` (یا معادل) با تعداد سطرهای تخصیص شده برابر است.
- **Failure:** هر mentor با mismatch → QaViolation شامل mentor_id/expected/assigned.

### QA_RULE_JOIN_01 — سلامت ۶ کلید Join
- **ورودی‌ها:** ماتریس و PolicyConfig (برای فهرست کلیدها).
- **Invariant:** هر یک از شش کلید join در ماتریس موجود، نوع عدد صحیح (int) دارد و مقدار تهی/NaN ندارد.
- **Failure:** نبود ستون، مقدار خالی یا نوع ناصحیح برای هر کلید → QaViolation با لیست ستون یا شمار nullها.

### QA_RULE_SCHOOL_01 — تفکیک منتور آزاد/مدرسه‌ای با MentorSchoolBindingPolicy
- **ورودی‌ها:** ماتریس (ستون `has_school_constraint` و `کد مدرسه`)، invalid_mentors/unmatched_schools، PolicyConfig.
- **Invariant:**
  - توکن‌های مدرسه خالی/صفر در Policy → منتور global بدون قید مدرسه (`has_school_constraint=False`) و نباید در diagnostics مدرسه دیده شوند.
  - توکن‌های مدرسه غیرخالی که با نگاشت Policy به کد معتبر تبدیل می‌شوند → منتور مقید (`has_school_constraint=True`) و باید `کد مدرسه` معتبر (>0) داشته باشد.
  - توکن‌های غیرخالی که نگاشت نمی‌شوند → منتور در خروجی مقید حضور ندارد؛ در `unmatched_schools`/`invalid_mentors` گزارش می‌شود و QA باید روی آن خطا بگیرد.
- **Failure:** ستون `has_school_constraint` مفقود، منتور آزاد در diagnostics مدرسه، یا منتور مقید با `کد مدرسه` تهی/0.

### QA_RULE_ALLOC_01 — ظرفیت و نسبت اشغال منتور
- **ورودی‌ها:** allocation، allocation_summary (با ستون‌های ظرفیت باقی‌مانده و occupancy_ratio/allocations_new).
- **Invariant:** برای هر mentor_id، `assigned_count ≤ remaining + allocations_new` و `occupancy_ratio = allocations_new / (remaining + allocations_new)` (با صفر شدن مخرج، نسبت 0).
- **Failure:** هر Mentor با تخصیص بیش از ظرفیت یا نسبت اشغال مغایر → QaViolation با جزئیات.

### QA_RULE_OUT_01 — حضور و شِمای خروجی‌های هسته
- **ورودی‌ها:** شیت‌ها/خروجی‌های نهایی (matrix, validation, invalid_mentors, allocations, trace و سایر شیت‌های اصلی).
- **Invariant:** همهٔ شیت‌های اصلی موجود و دارای ستون‌های قراردادشده (کلیدهای join، capacity/summary، trace) هستند تا QA بتواند نتایج را به‌صورت تکرارپذیر ارزیابی کند.
- **Failure:** فقدان شیت یا شِمای ناقص → QaViolation و وضعیت `FAILED_QA`، با ارجاع به نام شیت/ستون مفقود.

## نکات تاریخچه و کانال
- HistoryStore همچنان تنها منبع سابقهٔ تخصیص است و ممکن است بر اساس الگوهای ظرفیت (مثلاً تعداد سالانهٔ تخصیص‌ها) به اپراتور پیشنهاد دهد پشتیبانی را `FROZEN` یا `RESTRICTED` کند، اما تا زمانی که mentor_status در Policy/SSoT تغییر نکند، Core رفتاری را عوض نمی‌کند.
- AllocationChannel همچنان فقط مسیر پردازش دانش‌آموزان را مشخص می‌کند و هیچ‌گاه جایگزین mentor_status نمی‌شود؛ ابتدا BuildMentorPool روی mentors اعمال می‌شود، سپس ماتریس و کانال‌ها بر اساس همان مجموعه ساخته می‌شوند.
