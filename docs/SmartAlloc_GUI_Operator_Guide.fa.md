# راهنمای اپراتور SmartAlloc GUI

## مقدمه
SmartAlloc به اپراتورها کمک می‌کند ماتریس احراز صلاحیت دانش‌آموزان و فرآیند تخصیص به پشتیبان‌ها را مطابق Policy واحد تولید کنند و خروجی ImportToSabt را برای ثبت نهایی بسازند. این راهنما تمام مراحل روزمره را به زبان ساده توضیح می‌دهد.

## پیش‌نیازها
- **سیستم‌عامل:** ویندوز 10 یا 11 نسخه 64بیتی با آخرین به‌روزرسانی‌ها.
- **کتابخانه‌های سیستمی:** نصب بسته‌های Microsoft Visual C++ Redistributable 2015-2022. در بیشتر سیستم‌ها وجود دارند؛ اگر برنامه اجرا نشد، از وب‌سایت رسمی مایکروسافت نصب کنید.
- **حالت توسعه (اختیاری):** نصب Python 3.10 به‌همراه `pip install -r requirements.txt` برای اجرا از سورس.
- **حالت بسته (پیشنهادی برای اپراتورها):** دریافت پوشه‌ی `dist/Matrix2-GUI/` که با PyInstaller ساخته شده و شامل فایل اجرایی `Matrix2-GUI.exe` (مطابق spec و README بسته‌بندی) است. نیازی به Python نیست.

## نحوه اجرای برنامه
- **حالت توسعه:** پس از نصب پیش‌نیازها، در پوشه‌ی پروژه فرمان زیر را اجرا کنید و منتظر بالا آمدن پنجره شوید:
  ```bash
  python run_gui.py
  ```
- **حالت بسته:** در پوشه‌ی منتشرشده `dist/Matrix2-GUI/` روی `Matrix2-GUI.exe` دوبار کلیک کنید. اولین اجرا ممکن است چند ثانیه طول بکشد تا پوشه‌ی تنظیمات کاربر ساخته شود.

## معرفی تب‌های رابط کاربری
### تب «ساخت ماتریس» (Build Matrix)
- ورودی‌ها: فایل‌های Inspactor، School، Crosswalk و سایر جداول مرجع که Policy نیاز دارد.
- خروجی: فایل `eligibility_matrix.xlsx` که مبنای همه‌ی مراحل بعدی است.
- چه زمانی استفاده می‌شود: ابتدای سال تحصیلی یا هر زمان که داده‌های مرجع اصلاح شده‌اند.

### تب «تخصیص» (Allocate)
- ورودی‌ها: فایل دانش‌آموزان، استخر منتورها، روسترها و سال/ترم موردنظر.
- مراحل پیشنهادی:
  1. انتخاب ماتریس ساخته‌شده.
  2. وارد کردن فایل دانش‌آموزان جدید.
  3. تعیین روسترها و پارامترهای ظرفیت.
  4. انتخاب مسیر خروجی برای فایل تخصیص.
- خروجی: فایل CSV/Excel تخصیص و در همان تب جعبه‌ی «خروجی Sabt». پس از اتمام، ImportToSabt آماده‌ی بارگذاری در سامانه Sabt خواهد بود.

### تب «موتور قواعد» (Rule Engine)
- کاربرد: وقتی ماتریس آماده دارید و می‌خواهید سناریوهای مختلف Rule Engine را روی همان داده اجرا کنید؛ برای مثال، replay تخصیص‌ها با تنظیمات متفاوت بدون ساخت ماتریس جدید.
- همان جعبه‌ی خروجی Sabt در این تب نیز حضور دارد تا بتوانید مستقیماً فایل Sabt را بر اساس خروجی موتور قواعد بسازید.

### گروه «خروجی Sabt (ImportToSabt)»
- **sabt_output:** مسیر فایل نهایی که باید به سامانه Sabt تحویل شود. پس از اجرا، فایل ایجاد یا جایگزین می‌شود.
- **sabt_config:** فایل JSON تنظیمات صادرکننده (پیش‌فرض در `config/SmartAlloc_Exporter_Config_v*.json`). اگر مسیر خالی بماند، مقدار پیش‌فرض برنامه استفاده می‌شود.
- **sabt_template (اختیاری):** اگر قالب Excel ویژه دارید انتخاب کنید؛ در صورت خالی بودن، برنامه ساختار Sheetها را از JSON می‌سازد.
- توصیه: قبل از اجرای مجدد، از فایل خروجی قبلی نسخه‌ی پشتیبان بگیرید تا در صورت نیاز قابل بازیابی باشد.

### تب «اعتبارسنجی» (Validate)
- هدف: کنترل کیفیت ماتریس یا خروجی تخصیص قبل از تحویل.
- مراحل معمول:
  1. انتخاب فایل ورودی (ماتریس یا تخصیص).
  2. انتخاب قوانین اعتبارسنجی مدنظر (در UI توضیح کوتاه دارد).
  3. اجرای اعتبارسنجی و بررسی گزارش شیت‌های خطا/هشدار.
- در این تب پیام‌های راهنما نشان داده می‌شود؛ در این راهنما صرفاً تأکید می‌شود که تمام ستون‌های اجباری و ظرفیت‌ها باید بدون مقدار خالی باشند و نتایج باید با Policy هماهنگ باشند.

### تب «توضیحات» (Explain)
- هدف: مشاهده‌ی Trace تصمیمات برای دانش‌آموز یا گروه خاص.
- پس از وارد کردن ورودی، برنامه شیت‌های توضیحی شامل مراحل هشت‌گانه‌ی فیلتر و ظرفیت را تولید می‌کند. از این شیت‌ها می‌توان برای پاسخ به سؤالات مدیران استفاده کرد.

## سناریوهای روزمره
### سناریوی شروع سال تحصیلی
1. جمع‌آوری فایل‌های مرجع به‌روز (Inspactor، School، Crosswalk، لیست پشتیبان‌ها).
2. اجرای تب «ساخت ماتریس» و ذخیره‌ی `eligibility_matrix.xlsx` در پوشه‌ی پروژه سال جدید.
3. وارد کردن دانش‌آموزان سال جدید در تب «تخصیص» و تنظیم پارامترها.
4. اجرای تخصیص و ذخیره‌ی خروجی CSV/Excel.
5. در همان تب، مسیرهای sabt_output و sabt_config را تنظیم و خروجی ImportToSabt را بسازید.
6. خروجی‌ها را در پوشه‌ی مشترک تیم ذخیره و اطلاع‌رسانی کنید.

### سناریوی به‌روزرسانی میانه سال
1. دریافت لیست دانش‌آموزان/منتورهای جدید.
2. اگر داده‌ی مرجع تغییر کرده است، تب «ساخت ماتریس» را دوباره اجرا کنید؛ در غیر این صورت از ماتریس موجود استفاده کنید.
3. در تب «تخصیص» یا «موتور قواعد»، ورودی جدید را بارگذاری و اجرا کنید.
4. خروجی Sabt را با همان تنظیمات بسازید و قبل از جایگزینی نسخه‌ی قبلی، فایل جدید را به صورت تاریخ‌دار ذخیره نمایید.

## مدیریت خطا
- **ورود فایل اشتباه یا بدون ستون لازم:** برنامه پیام خطای واضح نمایش می‌دهد و اجرا متوقف می‌شود. فایل را اصلاح کرده و دوباره انتخاب کنید.
- **کمبود ظرفیت یا مقدار صفر:** در خروجی هشدار داده می‌شود؛ لازم است ظرفیت را در فایل ورودی اصلاح کنید.
- **پیام‌های دیگر:** تمامی خطاها با متن فارسی در پایین تب و در لاگ نمایش داده می‌شوند.
- **خطاهای غیرمنتظره:** نگهبان خطا (exception guard) پیام کلی فارسی نشان می‌دهد و جزئیات در فایل `%USERPROFILE%/Matrix2/logs/gui_crash.log` ذخیره می‌شود. این فایل را برای تیم پشتیبانی ارسال کنید.

## نکات پایانی
- همیشه قبل از جایگزینی، از خروجی‌های قبلی (مخصوصاً فایل Sabt) نسخه‌ی پشتیبان بگیرید.
- فایل `config/policy.json` و سایر تنظیمات Policy توسط تیم سیاست نگه‌داری می‌شوند؛ تغییر آن‌ها بدون هماهنگی می‌تواند نتایج را نامعتبر کند.
- پس از هر اجرای موفق، مسیر تنظیمات کاربر (AppPreferences) را بررسی کنید تا مطمئن شوید مسیرهای آخرین استفاده ذخیره شده‌اند و اجرای بعدی سریع‌تر انجام می‌شود.
