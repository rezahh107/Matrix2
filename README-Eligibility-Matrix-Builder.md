# Eligibility Matrix Builder — مستند اجرا و نگهداشت
**نسخهٔ اسکریپت:** v1.0.4  |  **SSoT:** v1.0.2

این سند راهنمای اجرای اسکریپت `build_matrix.py` و الزامات ورودی/خروجی آن است. این اسکریپت برای ساخت «ماتریس صلاحیت» از سه ورودی اصلی (Inspactor/School/Crosswalk) و یک ورودی اختیاری (StudentReport) طراحی شده است.

---

## 1) خلاصهٔ منطق
- **پشتیبان عادی** (Normal): برای هر ترکیب، **هردو وضعیت** ساخته می‌شود ⇒ `دانش‌آموز=1` و `فارغ‌التحصیل=0`.
- **پشتیبان مدرسه‌ای** (School): **فقط وضعیت دانش‌آموز=1** ساخته می‌شود.
- **قوانین دیگر:** دروازهٔ ظرفیت (Capacity Gate)، نگاشت «کراس‌واک» با سینونیم/باکت‌ها، حالات مالی ۰/۱/۳، نگاشت مرکز از روی نام مدیر، و نوشتن اتمیک فایل‌های خروجی.
- **پچ (v1.0.4):** اگر «کد مدرسه» خالی باشد، در خروجی ستون **«کد مدرسه» مقدار `0`** می‌گیرد (برای ردیف‌های عادی).

---

## 2) پیش‌نیازها
- **Python 3.10+** (پیشنهاد: 3.11 یا 3.12)
- کتابخانه‌ها:
  - `pandas`, `numpy`, `openpyxl` (خواندن XLSX)، `xlsxwriter` (نوشتن XLSX)، `tqdm` (اختیاری – نمایش پیشرفت)
- نصب سریع:
  ```bash
  # Linux/macOS
  python -m pip install -U pandas numpy openpyxl xlsxwriter tqdm
  ```
  ```powershell
  # Windows (PowerShell)
  py -m pip install -U pandas numpy openpyxl xlsxwriter tqdm
  ```

> نکته: اگر دسترسی به PyPI محدود است، بسته‌ها را از قبل دانلود/آفلاین نصب کنید یا یک آینه داخلی تعریف کنید.

---

## 3) ورودی‌ها و الزامات ستون‌ها

### 3.1) InspactorReport.xlsx (شیت اول)
ستون‌های موردنیاز/پشتیبانی‌شده (وجود بعضی‌ها اختیاری است اما در منطق اثر دارند):
- اجباری برای تولید ردیف‌ها:
  - **`نام پشتیبان`**، **`نام مدیر`**، **`کد کارمندی پشتیبان`**
- توصیه‌شده/اختیاری:
  - **`کدپستی`** (برای تشخیص پشتیبان عادی و مقدار «جایگزین»)،
  - **`نام مدرسه 1..4`** و/یا **`تعداد مدارس تحت پوشش`** (برای پشتیبان مدرسه‌ای)،
  - **`جنسیت`**،
  - **ستون‌های «گروه آزمایشی*»** (یک یا چند ستون)،
  - **`شامل گروه های آزمایشی`** (لیست/رنج کُد گروه‌ها؛ در صورت وجود بر گروه‌های متنی ارجح است)،
  - **`امکان جذب دانش آموز`** (یکی از: `بلی/بله/Yes/1/true` → اجازهٔ تولید ردیف).
- برای دروازهٔ ظرفیت (اگر فعال باشد):
  - **`تعداد داوطلبان تحت پوشش`** و **`تعداد تحت پوشش خاص`**.

### 3.2) SchoolReport.xlsx (شیت اول)
- **اجباری:** **`کد مدرسه`**
- حداقل یک ستون نام مدرسه: مانند **`نام مدرسه`** یا **`نام مدرسه 1`**

### 3.3) Crosswalk.xlsx
- شیت **`پایه تحصیلی (گروه آزمایشی)`** با ستون‌های: **`گروه آزمایشی`**، **`کد گروه`**، **`مقطع تحصیلی`**
- شیت اختیاری **`Synonyms`** با دو ستون (مثلاً from/to یا alias/target) برای سینونیم‌ها/باکت‌ها.

### 3.4) StudentReport.xlsx (اختیاری – برای اعتبارسنجی)
- یکی از این ستون‌ها: **`کد پستی`** یا **`کد جایگزین`**
- **`کد رشته`** (اولویت اول برای استخراج `group_code`؛ در نبود آن، نگاشت «گروه آزمایشی» استفاده می‌شود)
- **`نام پشتیبان`**، **`مدیر`**، و در صورت نبود «کد رشته» حداقل یک ستون **`گروه آزمایشی`**
- یک ستون نام مدرسه (اختیاری؛ کمک به تطبیق مدرسه‌ای)
- ستون **`جنسیت`** در صورت نبودن، از مسیر فایل یا policy استنباط می‌شود (`--students-gender`).

> اگر هر دو مقدار «کد رشته» و «گروه آزمایشی» موجود باشند ولی تطابق نداشته باشند، مقدار «کد رشته» مبناست و هشدار در لاگ ثبت می‌شود.

---

## 4) اجرای سریع

### 4.1) نمونهٔ اجرا (Linux/macOS)
```bash
python build_matrix.py   --inspactor ./data/InspactorReport.xlsx   --schools   ./data/SchoolReport.xlsx   --crosswalk ./data/Crosswalk.xlsx   --outdir    ./out   --log-level INFO
```

### 4.2) نمونهٔ اجرا (Windows PowerShell)
```powershell
py build_matrix.py `
  --inspactor .\data\InspactorReport.xlsx `
  --schools   .\data\SchoolReport.xlsx `
  --crosswalk .\data\Crosswalk.xlsx `
  --outdir    .\out `
  --log-level INFO
```

### 4.3) افزودن اعتبارسنجی با StudentReport
```bash
python build_matrix.py   --inspactor ./data/InspactorReport.xlsx   --schools   ./data/SchoolReport.xlsx   --crosswalk ./data/Crosswalk.xlsx   --students  ./data/StudentReport.xlsx   --students-gender auto   --outdir    ./out
```

### 4.4) غیرفعال‌کردن دروازهٔ ظرفیت (دیباگ)
```bash
python build_matrix.py ... --no-capacity-gate
```

> سطوح لاگ: `DEBUG | INFO | WARNING | ERROR | CRITICAL`

---

## 5) خروجی‌ها
در پوشهٔ `--outdir` ساخته می‌شوند:

- **`eligibility_matrix.csv`** — ماتریس نهایی (UTF-8 BOM)
- **`eligibility_matrix.xlsx`** — با شیت‌های:
  - `matrix` (خروجی اصلی؛ شامل ستون‌هایی نظیر: `جایگزین`, `پشتیبان`, `مدیر`, `کدرشته`, `جنسیت`, `دانش آموز فارغ`, `مرکز گلستان صدرا`, `مالی حکمت بنیاد`, `کد مدرسه`, `عادی مدرسه`, `نام مدرسه`, ...)
  - `validation` (خلاصهٔ شمارشی: total_rows, distinct_supporters, finance_*, ...)
  - `removed_mentors` (اگر Capacity Gate کسی را حذف کند)
  - `unmatched_schools` (کُد/نام مدرسه‌ای که در SchoolReport پیدا نشد)
  - `unseen_groups` (توکن‌های گروه آزمایشی که در Crosswalk تطبیق نشد)
  - `invalid_mentors` (ردیف‌های فاقد «کد کارمندی پشتیبان»)
  - `meta` (اطلاعات ساخت: زمان/میزبان/پیکربندی/mtime ورودی‌ها)

در صورت اجرای اعتبارسنجی:
- **`matrix_vs_students_validation.xlsx`** با شیت‌های `checks`, `breakdown`, `summary`, `meta`
- اگر عدم‌تطبیق وجود داشته باشد: **`unmatched_students.csv`** (ستون‌های کلیدی برای عیب‌یابی)

---

## 6) قواعد اصلی و نکات داده‌ای
- **عادی vs مدرسه‌ای**
  - اگر `کدپستی` معتبر (۴ رقمی بین `1000..9999`) باشد ⇒ **عادی** و ستون `جایگزین` = همان کدپستی.
  - اگر مدرسه دارد/می‌تواند داشته باشد (`تعداد مدارس تحت پوشش`>0 یا `نام مدرسه 1..4`) ⇒ **مدرسه‌ای** و `جایگزین` = **کد کارمندی پشتیبان**.
- **سیاست وضعیت‌ها**
  - **عادی:** هر دو وضعیت `1` (دانش‌آموز) و `0` (فارغ‌التحصیل)
  - **مدرسه‌ای:** فقط `1` (دانش‌آموز)
- **پچ «کد مدرسه»**
  - اگر مدرسه‌ای نباشد/خالی باشد ⇒ در خروجی ستون **`کد مدرسه` = 0**
- **مالی (`مالی حکمت بنیاد`)**: سه مقدار ممکن: `0` (عادی)، `1` (بنیاد)، `3` (حکمت)
- **مرکز از روی مدیر** (قابل‌تغییر در `BuildConfig.center_manager_map`):
  - `"شهدخت کشاورز" → گلستان`، `"آیناز هوشمند" → صدرا`، سایرین `مرکز`

---

## 7) سوییچ‌ها و پیکربندی
- `--log-level`: سطح لاگ
- `--no-capacity-gate`: عبور از R0
- `--students` و `--students-gender={auto|male|female}`
- کلاس `BuildConfig` داخل کد (برای استفادهٔ برنامه‌نویسان):
  - `finance_variants`, `enable_capacity_gate`, `center_manager_map`, `can_allocate_truthy`, ...

---

## 8) رفع اشکال (Troubleshooting)
- **Missing columns / ValueError**: بررسی کنید نام دقیق ستون‌ها مطابق **بخش 3** باشد (فاصله/نیم‌فاصله/کاراکترهای عربی→فارسی).
- **`ImportError: openpyxl not found`**: `pip install -U openpyxl`
- **`xlsxwriter` خطا**: `pip install -U xlsxwriter`
- **ظرفیت**: اگر ستون‌های ظرفیت وجود ندارند، پیام `skipping capacity gate` فقط هشدار است و اجرا ادامه می‌یابد.
- **حافظه/کارایی**: برای فایل‌های خیلی بزرگ، از Python 64bit و فضای دیسک کافی استفاده کنید؛ خروجی XLSX به‌صورت اتمیک نوشته می‌شود.
- **لاگ بیشتر**: با `--log-level DEBUG` خروجی گام‌به‌گام ببینید.

---

## 9) مثال ساختار پوشه‌ها
```
project-root/
├─ build_matrix.py
├─ data/
│  ├─ InspactorReport.xlsx
│  ├─ SchoolReport.xlsx
│  └─ Crosswalk.xlsx
└─ out/
   ├─ eligibility_matrix.csv
   ├─ eligibility_matrix.xlsx
   ├─ matrix_vs_students_validation.xlsx (اختیاری)
   └─ unmatched_students.csv (اختیاری)
```

---

## 10) تاریخچهٔ تغییرات (Changelog)
- **v1.0.4**: افزودن پچ «کد مدرسه خالی ⇒ 0»، تمیزکاری لاگ و متا.
- **v1.0.3 و قبل**: بهبود نرمال‌سازی فارسی، توسعهٔ سینونیم/باکت، R0 Capacity Gate، اعتبارسنجی اختیاری با StudentReport.

---

## 11) پرسش‌های متداول
- **چرا بعضی گروه‌ها به `unseen_groups` می‌روند؟** چون در Crosswalk یا Synonyms یافت نشده‌اند یا نامشان استانداردسازی (normalize) نشده است.
- **چرا بعضی مدارس `unmatched_schools` هستند؟** کد/نام در SchoolReport موجود نیست یا اختلاف نرمال‌سازی دارند.
- **چطور مراکز جدید اضافه کنم؟** نگاشت `center_manager_map` را در `BuildConfig` به‌روزرسانی کنید.

---

*تهیه و نگهداری: تیم RH / Eligibility Matrix Builder*